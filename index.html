<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KoboldCpp Character Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --secondary: #ec4899;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --lighter: #ffffff;
            --success: #10b981;
            --info: #3b82f6;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #94a3b8;
            --gray-dark: #475569;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-dark: rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-primary: 0 0 15px rgba(124, 58, 237, 0.3);
            --shadow-primary-lg: 0 0 25px rgba(124, 58, 237, 0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 0.75rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: var(--transition-slow);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.dark-mode {
            background-color: var(--darker);
            color: var(--light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(124, 58, 237, 0.1);
            position: relative;
        }

        body.dark-mode header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0.1;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.025em;
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transform: scaleX(0);
            transform-origin: left;
            transition: var(--transition);
        }

        h1:hover::after {
            transform: scaleX(1);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            color: var(--primary);
            transform: rotate(15deg) scale(1.1);
            box-shadow: var(--shadow-primary);
        }

        body.dark-mode .theme-toggle {
            color: var(--gray);
            background-color: var(--glass-dark);
        }

        body.dark-mode .theme-toggle:hover {
            color: var(--primary-light);
        }

        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1024px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background-color: var(--lighter);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition-slow);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(124, 58, 237, 0.05);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.03), rgba(236, 72, 153, 0.03));
            z-index: -1;
            opacity: 0;
            transition: var(--transition-slow);
        }

        .panel:hover::before {
            opacity: 1;
        }

        body.dark-mode .panel {
            background-color: rgba(15, 23, 42, 0.8);
            border-color: rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .panel::before {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(236, 72, 153, 0.05));
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(124, 58, 237, 0.1);
            position: relative;
        }

        body.dark-mode .panel-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-title i {
            font-size: 1.1em;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary-light), var(--secondary));
            opacity: 0;
            transition: var(--transition);
            z-index: -1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary-lg);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-outline::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            opacity: 0;
            transition: var(--transition);
            z-index: -1;
        }

        body.dark-mode .btn-outline {
            color: var(--light);
            border-color: var(--light);
        }

        .btn-outline:hover {
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary);
        }

        .btn-outline:hover::before {
            opacity: 1;
        }

        body.dark-mode .btn-outline:hover {
            color: white;
        }

        textarea, input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: var(--lighter);
            color: var(--dark);
            box-shadow: var(--shadow-sm);
        }

        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow-primary);
        }

        body.dark-mode textarea,
        body.dark-mode input,
        body.dark-mode select {
            background-color: rgba(15, 23, 42, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--lighter);
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            scroll-behavior: smooth;
        }

        body.dark-mode .chat-container {
            background-color: rgba(15, 23, 42, 0.5);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            animation: messageIn 0.3s ease-out;
            box-shadow: var(--shadow-sm);
            line-height: 1.5;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
            box-shadow: var(--shadow-primary);
        }

        .ai-message {
            background-color: var(--lighter);
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .ai-message {
            background-color: rgba(30, 41, 59, 0.8);
            color: var(--light);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.5rem;
            display: block;
            text-align: right;
        }

        .ai-message .message-time {
            color: var(--gray);
        }

        body.dark-mode .ai-message .message-time {
            color: var(--gray);
        }

        .debug-container {
            height: 400px;
            overflow-y: auto;
            background-color: var(--lighter);
            border-radius: var(--border-radius-lg);
            padding: 1rem;
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            scroll-behavior: smooth;
        }

        body.dark-mode .debug-container {
            background-color: rgba(15, 23, 42, 0.5);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .debug-entry {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.2);
            animation: fadeIn 0.3s ease-out;
        }

        body.dark-mode .debug-entry {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .debug-method {
            font-weight: bold;
            color: var(--success);
        }

        .debug-url {
            color: var(--info);
        }

        .debug-status {
            font-weight: bold;
        }

        .status-success {
            color: var(--success);
        }

        .status-error {
            color: var(--danger);
        }

        .tab-container {
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(124, 58, 237, 0.1);
            position: relative;
        }

        body.dark-mode .tabs {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-dark);
            position: relative;
        }

        body.dark-mode .tab {
            color: var(--gray);
        }

        .tab:hover {
            color: var(--primary);
        }

        body.dark-mode .tab:hover {
            color: var(--primary-light);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        body.dark-mode .tab.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .tab-content {
            display: none;
            padding: 1rem 0;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .code-block {
            background-color: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            overflow-x: auto;
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            box-shadow: var(--shadow-md);
        }

        .token-key {
            color: #c678dd;
        }

        .token-value {
            color: #98c379;
        }

        .token-string {
            color: #e06c75;
        }

        .token-number {
            color: #d19a66;
        }

        .loading {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 3px solid rgba(124, 58, 237, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-online {
            background-color: var(--success);
            box-shadow: 0 0 5px var(--success);
        }

        .status-offline {
            background-color: var(--danger);
            box-shadow: 0 0 5px var(--danger);
        }

        .character-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.75rem;
            font-size: 1.25rem;
            box-shadow: var(--shadow-primary);
            flex-shrink: 0;
        }

        .character-selector {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }

        .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.5s ease-out;
            padding: 0.75rem 1rem;
            background-color: rgba(124, 58, 237, 0.05);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary);
        }

        body.dark-mode .character-info {
            background-color: rgba(124, 58, 237, 0.1);
        }

        .character-name {
            font-weight: 600;
            color: var(--primary);
        }

        body.dark-mode .character-name {
            color: var(--primary-light);
        }

        .character-description {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(124, 58, 237, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        body.dark-mode ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        /* Floating particles background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            opacity: 0.1;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-1000px) rotate(720deg); }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark);
            color: var(--light);
            text-align: center;
            border-radius: var(--border-radius);
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: var(--transition);
            font-size: 0.8rem;
            box-shadow: var(--shadow-md);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }
            
            .app-grid {
                gap: 1rem;
            }
            
            .panel {
                padding: 1rem;
            }
            
            .btn, .btn-outline {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-primary-lg);
            cursor: pointer;
            z-index: 100;
            transition: var(--transition);
            border: none;
        }

        .fab:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
        }

        /* Confetti effect */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            opacity: 0;
            z-index: 9999;
            animation: confetti 5s ease-out;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(1000px) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> KoboldCpp Character Chat</h1>
            <button class="theme-toggle tooltip" id="themeToggle">
                <i class="fas fa-moon"></i>
                <span class="tooltip-text">Toggle Dark Mode</span>
            </button>
        </header>

        <div class="app-grid">
            <div class="chat-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-comments"></i> Character Chat</h2>
                        <div>
                            <span class="status-indicator status-online" id="apiStatus"></span>
                            <span id="apiStatusText">API Connected</span>
                        </div>
                    </div>

                    <div class="character-selector">
                        <select id="characterSelect" class="btn-outline">
                            <option value="">Custom Character</option>
                            <option value="assistant">AI Assistant</option>
                            <option value="storyteller">Storyteller</option>
                            <option value="therapist">Therapist</option>
                        </select>
                        <button class="btn-outline tooltip" id="showCharacterBtn">
                            <i class="fas fa-eye"></i> View
                            <span class="tooltip-text">View Character Prompt</span>
                        </button>
                    </div>

                    <div id="characterInfo" class="character-info" style="display: none;">
                        <div class="character-avatar" id="characterAvatar">A</div>
                        <div>
                            <div class="character-name" id="characterName">AI Assistant</div>
                            <div class="character-description" id="characterDescription">Helpful AI assistant</div>
                        </div>
                    </div>

                    <div class="chat-container" id="chatContainer">
                        <!-- Messages will appear here -->
                        <div class="message ai-message">
                            Welcome to KoboldCpp Character Chat! Select a character from the dropdown to start chatting.
                            <div class="message-time">System</div>
                        </div>
                    </div>

                    <textarea id="promptInput" placeholder="Type your message here..." rows="3"></textarea>
                    <div style="display: flex; justify-content: space-between;">
                        <button class="btn-outline tooltip" id="showCodeBtn">
                            <i class="fas fa-code"></i> Show Code
                            <span class="tooltip-text">View API Request Code</span>
                        </button>
                        <button class="btn" id="sendButton">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>

            <div class="debug-section">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title"><i class="fas fa-bug"></i> API Debugger</h2>
                        <button class="btn-outline tooltip" id="clearDebugBtn">
                            <i class="fas fa-trash"></i> Clear
                            <span class="tooltip-text">Clear Debug Log</span>
                        </button>
                    </div>

                    <div class="tab-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="debug">Debug Log</div>
                            <div class="tab" data-tab="request">Request</div>
                            <div class="tab" data-tab="response">Response</div>
                            <div class="tab" data-tab="code">Code</div>
                        </div>
                        <div class="tab-content active" id="debugTab">
                            <div class="debug-container" id="debugLog">
                                <!-- Debug logs will appear here -->
                                <div class="debug-entry">
                                    <div><strong>System</strong> <span class="status-info">INFO</span></div>
                                    <div>Ready to connect to KoboldCpp API</div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" id="requestTab">
                            <div class="debug-container" id="requestView">
                                <!-- Request data will appear here -->
                            </div>
                        </div>
                        <div class="tab-content" id="responseTab">
                            <div class="debug-container" id="responseView">
                                <!-- Response data will appear here -->
                            </div>
                        </div>
                        <div class="tab-content" id="codeTab">
                            <div class="code-block" id="codeView">
                                <pre><code>// Select a tab to view the code</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating action button -->
    <button class="fab" id="newChatBtn">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const chatContainer = document.getElementById('chatContainer');
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const debugLog = document.getElementById('debugLog');
        const requestView = document.getElementById('requestView');
        const responseView = document.getElementById('responseView');
        const codeView = document.getElementById('codeView');
        const clearDebugBtn = document.getElementById('clearDebugBtn');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const characterSelect = document.getElementById('characterSelect');
        const showCharacterBtn = document.getElementById('showCharacterBtn');
        const characterInfo = document.getElementById('characterInfo');
        const characterAvatar = document.getElementById('characterAvatar');
        const characterName = document.getElementById('characterName');
        const characterDescription = document.getElementById('characterDescription');
        const apiStatus = document.getElementById('apiStatus');
        const apiStatusText = document.getElementById('apiStatusText');
        const newChatBtn = document.getElementById('newChatBtn');
        const particlesContainer = document.getElementById('particles');

        // State
        let conversationHistory = [];
        let currentCharacter = null;
        let isDarkMode = false;
        let apiUrl = 'https://koboldai-koboldcpp-tiefighter.hf.space/api/v1/generate';

        // Character definitions
        const characters = {
            'assistant': {
                name: 'AI Assistant',
                description: 'Helpful and knowledgeable AI assistant',
                avatar: 'A',
                color: '#7c3aed',
                systemPrompt: 'You are a helpful, respectful and honest AI assistant. Always answer as helpfully as possible, while being safe. Your answers should not include any harmful, unethical, racist, sexist, toxic, dangerous, or illegal content. Please ensure that your responses are socially unbiased and positive in nature.'
            },
            'storyteller': {
                name: 'Storyteller',
                description: 'Creative storyteller who crafts engaging narratives',
                avatar: 'S',
                color: '#9d50bb',
                systemPrompt: 'You are a master storyteller with incredible creativity and imagination. You specialize in crafting engaging, immersive stories with rich characters and vivid descriptions. Always respond in character as the storyteller, and continue the narrative based on the user\'s input.'
            },
            'therapist': {
                name: 'Therapist',
                description: 'Empathetic counselor providing mental health support',
                avatar: 'T',
                color: '#4776E6',
                systemPrompt: 'You are a compassionate, licensed therapist with 20 years of experience. Your role is to provide supportive, non-judgmental listening and offer research-based therapeutic techniques. Always respond with empathy and care, asking thoughtful questions to help the user explore their feelings. Never provide medical advice or diagnoses.'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            checkApiStatus();
            loadTheme();
            setupEventListeners();
        });

        // Create floating particles
        function createParticles() {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                // Random properties
                const size = Math.random() * 10 + 5;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100 + 100;
                const delay = Math.random() * 15;
                const duration = Math.random() * 20 + 10;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}%`;
                particle.style.bottom = `-${size}px`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#7c3aed', '#8b5cf6', '#ec4899', '#3b82f6', '#10b981'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                
                // Random properties
                const size = Math.random() * 10 + 5;
                const posX = Math.random() * 100;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const delay = Math.random() * 5;
                const duration = Math.random() * 3 + 2;
                
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.left = `${posX}%`;
                confetti.style.backgroundColor = color;
                confetti.style.animationDelay = `${delay}s`;
                confetti.style.animationDuration = `${duration}s`;
                
                document.body.appendChild(confetti);
                
                // Remove after animation
                setTimeout(() => {
                    confetti.remove();
                }, duration * 1000);
            }
        }

        // Theme management
        function loadTheme() {
            isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            
            // Update tooltip
            themeToggle.querySelector('.tooltip-text').textContent = isDarkMode ? 'Toggle Light Mode' : 'Toggle Dark Mode';
        }

        // API Status Check
        async function checkApiStatus() {
            try {
                const response = await fetch(apiUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'accept': 'application/json'
                    }
                });
                                
                if (response.ok) {
                    apiStatus.className = 'status-indicator status-online';
                    apiStatusText.textContent = 'API Connected';
                    addDebugLog('API Status', 'Successfully connected to KoboldCpp API', 'success');
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                apiStatus.className = 'status-indicator status-offline';
                apiStatusText.textContent = 'API Offline';
                addDebugLog('API Status', `Error connecting to API: ${error.message}`, 'error');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            themeToggle.addEventListener('click', toggleTheme);
            sendButton.addEventListener('click', sendMessage);
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            clearDebugBtn.addEventListener('click', clearDebugLog);
            showCodeBtn.addEventListener('click', showCurrentCode);
            showCharacterBtn.addEventListener('click', showCharacterPrompt);
            characterSelect.addEventListener('change', handleCharacterChange);
            newChatBtn.addEventListener('click', startNewChat);

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                                        
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
                });
            });
        }

        // Character Management
        function handleCharacterChange() {
            const characterId = characterSelect.value;
            if (characterId) {
                currentCharacter = characters[characterId];
                characterInfo.style.display = 'flex';
                characterAvatar.textContent = currentCharacter.avatar;
                characterAvatar.style.background = `linear-gradient(45deg, ${currentCharacter.color}, ${currentCharacter.color}80)`;
                characterName.textContent = currentCharacter.name;
                characterDescription.textContent = currentCharacter.description;
                                
                // Add system message to conversation
                addSystemMessage(currentCharacter.systemPrompt);
                addDebugLog('Character', `Loaded character: ${currentCharacter.name}`, 'info');
                
                // Show welcome message
                addMessage('ai', `Hello! I'm ${currentCharacter.name}. ${currentCharacter.description}. How can I help you today?`);
            } else {
                currentCharacter = null;
                characterInfo.style.display = 'none';
            }
        }

        function showCharacterPrompt() {
            if (currentCharacter) {
                addDebugLog('Character Prompt', currentCharacter.systemPrompt, 'info');
                document.querySelector('.tab[data-tab="debug"]').click();
            } else {
                addDebugLog('Character', 'No character selected', 'warning');
            }
        }

        // Start new chat
        function startNewChat() {
            // Animation effect
            createConfetti();
            
            // Clear conversation
            conversationHistory = [];
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    New chat started. Select a character from the dropdown to begin.
                    <div class="message-time">System</div>
                </div>
            `;
            
            addDebugLog('Chat', 'Started a new conversation', 'info');
        }

        // Message Handling
        function sendMessage() {
            const message = promptInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            promptInput.value = '';

            // Show loading indicator
            const loadingId = `loading-${Date.now()}`;
            chatContainer.innerHTML += `
                <div id="${loadingId}" class="message ai-message">
                    <div class="loading"></div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Prepare the full prompt with conversation history
            let fullPrompt = '';
            if (currentCharacter) {
                fullPrompt += `${currentCharacter.systemPrompt}\n\n`;
            }
                        
            conversationHistory.forEach(msg => {
                fullPrompt += `${msg.role === 'user' ? 'User' : 'AI'}: ${msg.content}\n`;
            });
            fullPrompt += `AI: `;

            // Prepare API request
            const requestData = {
                "max_context_length": 2048,
                "max_length": 2408,
                "prompt": fullPrompt,
                "quiet": false,
                "rep_pen": 1.1,
                "rep_pen_range": 256,
                "rep_pen_slope": 1,
                "temperature": 0.7,
                "tfs": 1,
                "top_a": 0,
                "top_k": 100,
                "top_p": 0.9,
                "typical": 1
            };

            // Debug request
            addDebugLog('Request', `Sending request to ${apiUrl}`, 'info');
            updateRequestView(requestData);
            document.querySelector('.tab[data-tab="request"]').click();

            // Show code
            updateCodeView(requestData);

            // Make API call
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Remove loading indicator
                document.getElementById(loadingId)?.remove();

                // Process response
                const generatedText = data.results[0].text.trim();
                addMessage('ai', generatedText);
                addDebugLog('Response', 'Received response from API', 'success');
                updateResponseView(data);
                document.querySelector('.tab[data-tab="response"]').click();
            })
            .catch(error => {
                // Remove loading indicator
                document.getElementById(loadingId)?.remove();
                                
                // Show error
                addMessage('ai', `Error: ${error.message}`);
                addDebugLog('Error', `API request failed: ${error.message}`, 'error');
            });
        }

        function addMessage(role, content) {
            const timestamp = new Date().toLocaleTimeString();
            const messageClass = role === 'user' ? 'user-message' : 'ai-message';
                        
            chatContainer.innerHTML += `
                <div class="message ${messageClass}">
                    ${content}
                    <div class="message-time">${timestamp}</div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add to conversation history
            conversationHistory.push({ role, content });
        }

        function addSystemMessage(content) {
            conversationHistory.push({ role: 'system', content });
        }

        // Debug Tools
        function addDebugLog(title, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'status-error' :
                             type === 'warning' ? 'status-warning' :
                             type === 'success' ? 'status-success' : 'status-info';

            debugLog.innerHTML += `
                <div class="debug-entry">
                    <div><strong>${title}</strong> <span class="${typeClass}">${type.toUpperCase()}</span></div>
                    <div>${timestamp}</div>
                    <div>${message}</div>
                </div>
            `;
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function updateRequestView(data) {
            requestView.textContent = JSON.stringify(data, null, 2);
        }

        function updateResponseView(data) {
            responseView.textContent = JSON.stringify(data, null, 2);
        }

        function updateCodeView(requestData) {
            const code = `// JavaScript Fetch API Example\nasync function generateText() {\n    const response = await fetch('${apiUrl}', {\n        method: 'POST',\n        headers: {\n            'accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(${formatObjectForCode(requestData)})\n    });\n\n    const data = await response.json();\n    const generatedText = data.results[0].text;\n    console.log(generatedText);\n}`;

            // Simple syntax highlighting
            const highlightedCode = code
                .replace(/(\/\/.*)/g, '<span class="token-comment">$1</span>')
                .replace(/(['"].*?['"])/g, '<span class="token-string">$1</span>')
                .replace(/\b(async|await|function|const|let|var)\b/g, '<span class="token-keyword">$1</span>')
                .replace(/\b(JSON\.stringify|console\.log|fetch)\b/g, '<span class="token-function">$1</span>')
                .replace(/\b(method|headers|body|response|data)\b/g, '<span class="token-variable">$1</span>')
                .replace(/(['"]\w+['"]\s*:)/g, '<span class="token-key">$1</span>')
                .replace(/(:\s*)([^{\s].*?)([,}\s])/g, '$1<span class="token-value">$2</span>$3')
                .replace(/\b(true|false|null)\b/g, '<span class="token-literal">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="token-number">$1</span>');

            codeView.innerHTML = `<pre><code>${highlightedCode}</code></pre>`;
        }

        function formatObjectForCode(obj) {
            return JSON.stringify(obj, null, 4)
                .replace(/"([^"]+)":/g, '$1:')
                .replace(/"/g, "'");
        }

        function showCurrentCode() {
            document.querySelector('.tab[data-tab="code"]').click();
        }

        function clearDebugLog() {
            debugLog.innerHTML = '';
            requestView.textContent = '';
            responseView.textContent = '';
            addDebugLog('Debug', 'Debug log cleared', 'info');
        }
    </script>
</body>
</html>
